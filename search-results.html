<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Search Results - TravelBook</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    <script src="search-service.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        header {
            background-color: #003580;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .logo a {
            color: white;
            text-decoration: none;
        }

        .logo span {
            color: #0071c2;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 20px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        nav ul li a:hover {
            color: #b8d6f3;
        }

        /* Search Section */
        .search-section {
            background-color: #003580;
            padding: 30px 0;
            color: white;
        }

        .search-container {
            background-color: #febb02;
            border-radius: 5px;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .search-title {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
        }

        .search-form {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 3px;
            font-size: 16px;
        }

        .search-btn {
            background-color: #0071c2;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .search-btn:hover {
            background-color: #00487a;
        }

        /* Search Info */
        .search-info {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .search-details {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .search-detail {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-detail i {
            color: #0071c2;
        }

        /* Main Content */
        .main-content {
            display: flex;
            margin: 30px 0;
            gap: 30px;
        }

        /* Filters Sidebar */
        .filters {
            flex: 0 0 280px;
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .filter-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .filter-section:last-child {
            border-bottom: none;
        }

        .filter-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-option input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-option label {
            cursor: pointer;
            font-size: 14px;
        }

        .star-rating {
            color: #ffb700;
            font-size: 14px;
        }

        /* Results Section */
        .results {
            flex: 1;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .results-title {
            font-size: 24px;
            font-weight: 600;
        }

        .results-count {
            color: #666;
            font-size: 16px;
            margin-top: 5px;
        }

        .sort-options {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .map-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #0071c2;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .map-toggle:hover {
            background-color: #00487a;
        }

        /* Hotel List */
        .hotel-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .hotel-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .hotel-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .hotel-image {
            flex: 0 0 300px;
            height: 220px;
            position: relative;
            overflow: hidden;
        }

        .hotel-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .hotel-card:hover .hotel-image img {
            transform: scale(1.05);
        }

        .hotel-details {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hotel-name {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #0071c2;
        }

        .hotel-location {
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .hotel-features {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .feature {
            background-color: #f0f8ff;
            color: #0071c2;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .hotel-description {
            color: #555;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .hotel-rating {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .rating-score {
            background-color: #003580;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .rating-text {
            font-size: 14px;
            color: #666;
        }

        .hotel-price {
            text-align: right;
        }

        .price-amount {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .price-period {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .tax-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .availability-btn {
            background-color: #0071c2;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            font-size: 14px;
        }

        .availability-btn:hover {
            background-color: #00487a;
        }

        /* Loading States */
        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #0071c2;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-container {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .error-message {
            color: #e74c3c;
            margin-bottom: 20px;
            font-size: 18px;
        }

        /* Footer */
        footer {
            background-color: #003580;
            color: white;
            padding: 40px 0 20px;
            margin-top: 50px;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 30px;
        }

        .footer-section {
            flex: 1;
            min-width: 200px;
        }

        .footer-title {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 8px;
        }

        .footer-links a {
            color: #b8d6f3;
            text-decoration: none;
            transition: color 0.3s;
            font-size: 14px;
        }

        .footer-links a:hover {
            color: white;
        }

        .copyright {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #00487a;
            color: #b8d6f3;
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            
            .filters {
                flex: 1;
                position: static;
            }
        }

        @media (max-width: 768px) {
            .hotel-card {
                flex-direction: column;
            }
            
            .hotel-image {
                flex: 1;
                height: 200px;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .search-form {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .search-details {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
 <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">TravelBook</a>
               
             
            </div>
        </div>
    </header>

    <!-- Search Section -->
    <section style="display: none;" class="search-section">
        <div class="container">
            <div class="search-container">
                <h2 class="search-title">Find your perfect stay</h2>
                <form class="search-form" id="search-form">
                    <input type="text" class="search-input" id="destination-search" placeholder="Where are you going?">
                    <button type="submit" class="search-btn">Search</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Search Info -->
    <div class="container">
        <div class="search-info">
            <div class="search-details" id="search-details">
                <!-- Search details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <!-- Filters Sidebar -->
            <aside class="filters">
                <div class="filter-section">
                    <h3 class="filter-title">Filter by:</h3>
                </div>
                
                <div class="filter-section">
                    <h3 class="filter-title">Star Rating</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="rating-5" data-rating="5">
                            <label for="rating-5">
                                <span class="star-rating">★★★★★</span> 5 stars
                            </label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="rating-4" data-rating="4">
                            <label for="rating-4">
                                <span class="star-rating">★★★★☆</span> 4 stars
                            </label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="rating-3" data-rating="3">
                            <label for="rating-3">
                                <span class="star-rating">★★★☆☆</span> 3 stars
                            </label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="rating-2" data-rating="2">
                            <label for="rating-2">
                                <span class="star-rating">★★☆☆☆</span> 2 stars
                            </label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="rating-1" data-rating="1">
                            <label for="rating-1">
                                <span class="star-rating">★☆☆☆☆</span> 1 star
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3 class="filter-title">Property Type</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="type-hotel" data-type="hotel">
                            <label for="type-hotel">Hotels</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="type-apartment" data-type="apartment">
                            <label for="type-apartment">Apartments</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="type-resort" data-type="resort">
                            <label for="type-resort">Resorts</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="type-villa" data-type="villa">
                            <label for="type-villa">Villas</label>
                        </div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3 class="filter-title">Review Score</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="score-9" data-score="9">
                            <label for="score-9">Wonderful 9+</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="score-8" data-score="8">
                            <label for="score-8">Very Good 8+</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="score-7" data-score="7">
                            <label for="score-7">Good 7+</label>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h3 class="filter-title">Price Range</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="price-1" data-price="0-100">
                            <label for="price-1">Under $100</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="price-2" data-price="100-200">
                            <label for="price-2">$100 - $200</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="price-3" data-price="200-300">
                            <label for="price-3">$200 - $300</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="price-4" data-price="300-500">
                            <label for="price-4">$300 - $500</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="price-5" data-price="500-1000">
                            <label for="price-5">$500 - $1000</label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Results Section -->
            <section class="results">
                <div class="results-header">
                    <div>
                        <h1 class="results-title" id="results-title">Search Results</h1>
                        <p class="results-count" id="results-count">Loading hotels...</p>
                    </div>
                    <div class="sort-options">
                        <select class="sort-select" id="sort-select">
                            <option value="recommended">Our top picks</option>
                            <option value="price_asc">Lowest Price First</option>
                            <option value="price_desc">Highest Price First</option>
                            <option value="rating_desc">Top reviewed</option>
                            <option value="stars_desc">Star rating (high to low)</option>
                            <option value="stars_asc">Star rating (low to high)</option>
                        </select>
                        <button class="map-toggle" id="map-toggle">
                            <i class="fas fa-map-marker-alt"></i>
                            Show on map
                        </button>
                    </div>
                </div>

                <!-- Hotel List -->
                <div class="hotel-list" id="hotel-list">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Loading hotels...</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3 class="footer-title">TravelBook</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Press</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3 class="footer-title">Support</h3>
                    <ul class="footer-links">
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3 class="footer-title">Destinations</h3>
                    <ul class="footer-links">
                        <li><a href="#">Kigali</a></li>
                        <li><a href="#">Gisenyi</a></li>
                        <li><a href="#">Ruhengeri</a></li>
                        <li><a href="#">Kibuye</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3 class="footer-title">Partners</h3>
                    <ul class="footer-links">
                        <li><a href="#">Property Owners</a></li>
                        <li><a href="#">Affiliate Program</a></li>
                        <li><a href="#">List Your Property</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                &copy; 2023 TravelBook. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // Initialize Search Service
        const searchService = new SearchService();

        // Global variables
        let currentHotels = [];
        let filteredHotels = [];
        let currentSearchParams = {};

        // Get URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const destination = urlParams.get('destination');
            
            return {
                dest_id: urlParams.get('dest_id'),
                search_type: urlParams.get('search_type') || 'city',
                destination: destination ? decodeURIComponent(destination) : '',
                checkin: urlParams.get('checkin'),
                checkout: urlParams.get('checkout'),
                guests: urlParams.get('guests') || '1'
            };
        }

        // Format currency
        function formatCurrency(amount, currency = 'USD') {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // Calculate number of nights
        function calculateNights(checkin, checkout) {
            const oneDay = 24 * 60 * 60 * 1000;
            const firstDate = new Date(checkin);
            const secondDate = new Date(checkout);
            return Math.round(Math.abs((firstDate - secondDate) / oneDay));
        }

        // Update search details display
        function updateSearchDetails(params) {
            const searchDetails = document.getElementById('search-details');
            const nights = calculateNights(params.checkin, params.checkout);
            
            searchDetails.innerHTML = `
                <div class="search-detail">
                    <i class="fas fa-map-marker-alt"></i>
                    <span><strong>Destination:</strong> ${params.destination || 'Unknown'}</span>
                </div>
                <div class="search-detail">
                    <i class="fas fa-calendar-alt"></i>
                    <span><strong>Dates:</strong> ${params.checkin || 'Check-in'} - ${params.checkout || 'Check-out'}</span>
                </div>
                <div class="search-detail">
                    <i class="fas fa-user-friends"></i>
                    <span><strong>Guests:</strong> ${params.guests || '1'} adult${params.guests > 1 ? 's' : ''}</span>
                </div>
                <div class="search-detail">
                    <i class="fas fa-moon"></i>
                    <span><strong>Nights:</strong> ${nights}</span>
                </div>
            `;
        }

        // Extract features from accessibility label
        function extractFeatures(accessibilityLabel) {
            const features = [];
            if (accessibilityLabel.includes('Free parking')) features.push('Free parking');
            if (accessibilityLabel.includes('Free WiFi')) features.push('Free WiFi');
            if (accessibilityLabel.includes('Swimming Pool')) features.push('Swimming Pool');
            if (accessibilityLabel.includes('Breakfast included')) features.push('Breakfast included');
            if (accessibilityLabel.includes('Garden')) features.push('Garden');
            if (accessibilityLabel.includes('Terrace')) features.push('Terrace');
            return features.slice(0, 4); // Return max 4 features
        }

        // Determine property type from name and features
        function getPropertyType(name, features) {
            const lowerName = name.toLowerCase();
            if (lowerName.includes('apartment') || lowerName.includes('apartments')) return 'Apartment';
            if (lowerName.includes('villa')) return 'Villa';
            if (lowerName.includes('resort')) return 'Resort';
            if (lowerName.includes('lodge')) return 'Lodge';
            if (features.includes('Swimming Pool') && features.includes('Garden')) return 'Resort';
            return 'Hotel';
        }

        // Render hotel cards
        function renderHotels(hotels) {
            const hotelList = document.getElementById('hotel-list');
            
            if (!hotels || hotels.length === 0) {
                hotelList.innerHTML = `
                    <div class="error-container">
                        <h3>No hotels found</h3>
                        <p>Try adjusting your search criteria or filters.</p>
                    </div>
                `;
                return;
            }

            const hotelsHtml = hotels.map(hotel => {
                const property = hotel.property;
                const price = property.priceBreakdown?.grossPrice?.value || 0;
                const originalPrice = property.priceBreakdown?.strikethroughPrice?.value;
                const imageUrl = property.photoUrls && property.photoUrls[0] ? 
                    property.photoUrls[0] : 
                    'https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
                
                const nights = calculateNights(currentSearchParams.checkin, currentSearchParams.checkout);
                const totalPrice = price * nights;
                
                // Extract features from accessibility label
                const features = extractFeatures(hotel.accessibilityLabel || '');
                const propertyType = getPropertyType(property.name, features);
                
                // Get star rating from property class
                const stars = property.accuratePropertyClass || property.propertyClass || 0;
                const reviewScore = property.reviewScore || 0;
                const reviewCount = property.reviewCount || 0;
                const reviewWord = property.reviewScoreWord || 'Not rated';

                // Generate star rating display
                const starDisplay = '★'.repeat(stars) + '☆'.repeat(5 - stars);

                return `
                    <div class="hotel-card">
                        <div class="hotel-image">
                            <img src="${imageUrl}" alt="${property.name}" onerror="this.src='https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
                        </div>
                        <div class="hotel-details">
                            <div>
                                <h2 class="hotel-name">${property.name}</h2>
                                <p class="hotel-location">
                                    <i class="fas fa-map-marker-alt"></i> ${property.wishlistName || 'Location not available'}
                                </p>
                                <div class="hotel-features">
                                    <span class="feature">${propertyType}</span>
                                    ${features.map(feature => `<span class="feature">${feature}</span>`).join('')}
                                </div>
                                <p class="hotel-description">
                                    ${hotel.accessibilityLabel ? hotel.accessibilityLabel.split('.')[0] + '.' : 'Comfortable accommodation with great amenities.'}
                                </p>
                                <div class="hotel-rating">
                                    ${stars > 0 ? `<span class="star-rating">${starDisplay}</span>` : ''}
                                    <span class="rating-score">${reviewScore.toFixed(1)}</span>
                                    <span class="rating-text">${reviewWord} • ${reviewCount} reviews</span>
                                </div>
                            </div>
                            <div class="hotel-price">
                                ${originalPrice ? `
                                    <div style="text-decoration: line-through; color: #999; font-size: 14px;">
                                        ${formatCurrency(originalPrice)}
                                    </div>
                                ` : ''}
                                <div class="price-amount">${formatCurrency(price)}</div>
                                <div class="price-period">per night</div>
                                <div class="tax-info">+ taxes & fees</div>
                                <button class="availability-btn" onclick="viewDetails(${hotel.hotel_id})">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            hotelList.innerHTML = hotelsHtml;
        }

        // View hotel details
        function viewDetails(hotelId) {
            window.location.href = `Details.html?hotel_id=${hotelId}&dest_id=${currentSearchParams.dest_id}&checkin=${currentSearchParams.checkin}&checkout=${currentSearchParams.checkout}&guests=${currentSearchParams.guests}`;
        }

        // Apply filters
        function applyFilters() {
            const selectedRatings = Array.from(document.querySelectorAll('input[data-rating]:checked')).map(el => parseInt(el.dataset.rating));
            const selectedTypes = Array.from(document.querySelectorAll('input[data-type]:checked')).map(el => el.dataset.type);
            const selectedScores = Array.from(document.querySelectorAll('input[data-score]:checked')).map(el => parseInt(el.dataset.score));
            const selectedPrices = Array.from(document.querySelectorAll('input[data-price]:checked')).map(el => el.dataset.price);

            filteredHotels = currentHotels.filter(hotel => {
                const property = hotel.property;
                const stars = property.accuratePropertyClass || property.propertyClass || 0;
                const score = property.reviewScore || 0;
                const price = property.priceBreakdown?.grossPrice?.value || 0;
                const type = getPropertyType(property.name, extractFeatures(hotel.accessibilityLabel || '')).toLowerCase();

                // Rating filter
                if (selectedRatings.length > 0 && !selectedRatings.includes(stars)) return false;

                // Type filter
                if (selectedTypes.length > 0 && !selectedTypes.some(t => type.includes(t))) return false;

                // Score filter
                if (selectedScores.length > 0 && !selectedScores.some(s => score >= s)) return false;

                // Price filter
                if (selectedPrices.length > 0) {
                    const priceInRange = selectedPrices.some(range => {
                        const [min, max] = range.split('-').map(Number);
                        return price >= min && price <= max;
                    });
                    if (!priceInRange) return false;
                }

                return true;
            });

            updateResultsCount();
            renderHotels(filteredHotels);
        }

        // Sort hotels
        function sortHotels(sortBy) {
            const hotels = filteredHotels.length > 0 ? filteredHotels : currentHotels;

            switch (sortBy) {
                case 'price_asc':
                    hotels.sort((a, b) => (a.property.priceBreakdown?.grossPrice?.value || 0) - (b.property.priceBreakdown?.grossPrice?.value || 0));
                    break;
                case 'price_desc':
                    hotels.sort((a, b) => (b.property.priceBreakdown?.grossPrice?.value || 0) - (a.property.priceBreakdown?.grossPrice?.value || 0));
                    break;
                case 'rating_desc':
                    hotels.sort((a, b) => (b.property.reviewScore || 0) - (a.property.reviewScore || 0));
                    break;
                case 'stars_desc':
                    hotels.sort((a, b) => {
                        const aStars = a.property.accuratePropertyClass || a.property.propertyClass || 0;
                        const bStars = b.property.accuratePropertyClass || b.property.propertyClass || 0;
                        return bStars - aStars;
                    });
                    break;
                case 'stars_asc':
                    hotels.sort((a, b) => {
                        const aStars = a.property.accuratePropertyClass || a.property.propertyClass || 0;
                        const bStars = b.property.accuratePropertyClass || b.property.propertyClass || 0;
                        return aStars - bStars;
                    });
                    break;
                default:
                    // Recommended - keep original order
                    break;
            }

            renderHotels(hotels);
        }

        // Update results count
        function updateResultsCount() {
            const displayCount = filteredHotels.length > 0 ? filteredHotels.length : currentHotels.length;
            document.getElementById('results-count').textContent = `${displayCount} properties found`;
        }

        // Initialize page
        async function initPage() {
            currentSearchParams = getUrlParams();
            updateSearchDetails(currentSearchParams);
            
            // Set the destination in the search box
            if (currentSearchParams.destination) {
                document.getElementById('destination-search').value = currentSearchParams.destination;
            }

            try {
                document.getElementById('results-title').textContent = `Hotels in ${currentSearchParams.destination || 'Your Destination'}`;
                
                // Log the parameters for debugging
                console.log('Search parameters:', currentSearchParams);
                
                // Prepare search parameters for hotels API
                const searchParams = {
                    search_type: 'city', // Always use 'city' for hotel searches
                    arrival_date: formatDateForAPI(currentSearchParams.checkin) || '2025-12-20',
                    departure_date: formatDateForAPI(currentSearchParams.checkout) || '2025-12-25',
                    adults: currentSearchParams.guests || 1,
                    children_age: '0,17',
                    room_qty: 1,
                    page_number: 1,
                    units: 'metric',
                    temperature_unit: 'c',
                    languagecode: 'en-us',
                    currency_code: 'USD'
                };

                console.log('Searching hotels with params:', {
                    dest_id: currentSearchParams.dest_id,
                    ...searchParams
                });

                const response = await searchService.searchHotels(currentSearchParams.dest_id, searchParams);
                
                console.log('API Response:', response);
                
                // Extract hotels from the response
                if (response && response.data && response.data.hotels) {
                    currentHotels = response.data.hotels;
                    filteredHotels = [...currentHotels];
                    updateResultsCount();
                    renderHotels(currentHotels);
                } else {
                    console.error('Invalid response structure:', response);
                    throw new Error('No hotels data found in response');
                }
            } catch (error) {
                console.error('Error loading hotels:', error);
                document.getElementById('hotel-list').innerHTML = `
                    <div class="error-container">
                        <p class="error-message">Error loading hotels. Please try again later.</p>
                        <p style="color: #666; margin-top: 10px; font-size: 14px;">
                            ${error.message}<br>
                            Make sure you selected a valid destination with hotels.
                        </p>
                        <button onclick="window.location.href='index.html'" 
                                style="margin-top: 15px; padding: 10px 20px; background: #0071c2; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Back to Search
                        </button>
                    </div>
                `;
            }
        }

        // Helper function to format dates for API
        function formatDateForAPI(dateString) {
            if (!dateString) return null;
            
            try {
                const date = new Date(dateString);
                return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            } catch (error) {
                console.error('Error formatting date:', error);
                return null;
            }
        }

        // Event listeners
        document.getElementById('sort-select').addEventListener('change', (e) => {
            sortHotels(e.target.value);
        });

        document.querySelectorAll('input[data-rating], input[data-type], input[data-score], input[data-price]').forEach(checkbox => {
            checkbox.addEventListener('change', applyFilters);
        });

        document.getElementById('map-toggle').addEventListener('click', () => {
            alert('Map view feature coming soon!');
        });

        document.getElementById('search-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const destination = document.getElementById('destination-search').value;
            if (destination) {
                window.location.href = `search-results.html?destination=${encodeURIComponent(destination)}&search_type=city`;
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
